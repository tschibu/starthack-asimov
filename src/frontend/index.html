<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>CrashSimulation - Asimov</title>
    <meta name="description" content="CrashSimulation">
    <meta name="author" content="Asimov">

    <link rel="stylesheet" href="/frontend/styles.css">
</head>

<body>
    <section class="title">
        <h2>CrashSimulation - Asimov</h2>
    </section>

    <section class="data">
        <h3>Filename:</h3>
        <h5 id="filename"></h5>
        <h3>impactAngle:</h3>
        <h5 id="impactAngle"></h5>
        <h3>offsetMaximumForce:</h3>
        <h5 id="offsetMaximumForce"></h5>
    </section>

    <section>
        <div id="image">
        </div>
    </section>

    <section class="upload">
        <div class="dropZone" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
            <p>Drag one JSON crash report file to this Drop Zone ...</p>
        </div>
    </section>

    <script>
        function dropHandler(ev) {
            ev.preventDefault();

            if (ev.dataTransfer.items) {
                var item = ev.dataTransfer.items[0];
                var file = item.getAsFile();
                console.log('Sending ' + file.name + ' to backend now...');

                setFileName(file.name);
                setValues("undefined", "undefined");

                getText(file, [requestCrashInfo, requestCrashImage]);
            }
        }

        function dragOverHandler(ev) {
            ev.preventDefault();
        }

        function requestCrashInfo(json_string) {
            var xhr = new XMLHttpRequest();

            var url = "http://"+window.location.hostname+":2828/api/v1/getCrashInfo";
            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    console.log("impactAngle: " + json.impactAngle);
                    console.log("offsetMaximumForce: " + json.offsetMaximumForce);
                    setValues(json.impactAngle, json.offsetMaximumForce);
                }
            };
            xhr.send(json_string);
        }

        function requestCrashImage(json_string) {
            var xhr = new XMLHttpRequest();

            var url = "http://"+window.location.hostname+":2828/api/v1/getCrashImage";
            xhr.open("POST", url, true);
            xhr.responseType = "blob";
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    setImage(xhr.response);
                }
            };
            xhr.send(json_string);
        }

        function getText(file, callback) {
            reader = new FileReader();
            reader.onload = function (event) {
                [...callback].forEach(cb => {
                    cb(event.target.result);
                });
            };
            reader.readAsText(file);
        }

        function setFileName(filename) {
            fn = document.getElementById("filename");
            fn.innerHTML = filename;
        }

        function setValues(impactAngle, offsetMaximumForce) {
            ia = document.getElementById("impactAngle");
            ia.innerHTML = impactAngle;

            omf = document.getElementById("offsetMaximumForce");
            omf.innerHTML = offsetMaximumForce;
        }

        function setImage(response) {
            img = document.getElementById('image');
            var reader = new FileReader();
            reader.onloadend = () => {
                console.log(reader.result);
                img.innerHTML = "<img class='image' src='" + reader.result + "'></img>";
            };
            reader.readAsDataURL(response);
        }
    </script>
</body>
</html>